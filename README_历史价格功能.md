# ETH/BTC历史价格功能使用说明

## 安装依赖
在运行程序前，请先安装必要的Python包：
```bash
pip install -r requirements.txt
```

## 功能概述
为了解决ETH/BTC交易估值问题，新增了自动历史价格获取功能。系统会自动从网络获取ETH和BTC的日元历史价格，这样"损益计算执行"按钮就能使用真实的历史价格来计算，避免估值误差。

## 使用方法

### 1. 自动获取历史价格
1. 加载CSV数据文件
2. 点击"自动获取ETH/BTC历史价格"按钮
3. 系统会自动分析CSV文件中的ETH/BTC交易日期
4. 自动从网络获取每个日期的ETH和BTC日元价格
5. 价格数据自动保存到JSON文件中

### 2. 价格数据格式
价格数据会保存到`historical_prices.json`文件中，格式如下：
```json
{
  "2024-01-15": {
    "ETH": 250000,
    "BTC": 4500000
  },
  "2024-02-20": {
    "ETH": 280000,
    "BTC": 5200000
  }
}
```

### 3. 价格数据来源
- **CoinGecko API**：免费的历史价格API，提供准确的日元价格数据
- **自动获取**：无需手动查询，系统自动获取所有需要日期的价格
- **实时更新**：每次运行都会获取最新的历史价格数据

### 4. 计算优先级
"损益计算执行"按钮现在会按以下优先级计算：
1. **历史价格优先**：如果找到对应日期的历史价格，使用历史价格
2. **回退到原方法**：如果没有历史价格，使用原来的BTC平均取得单价方法

## 优势

### 使用历史价格前
- ETH/BTC交易使用BTC平均取得单价估值
- 可能产生较大误差，特别是BTC价格波动大的时候
- 计算结果不够准确

### 使用历史价格后
- ETH/BTC交易使用真实的历史价格
- 计算结果更准确，反映真实的市场情况
- 避免了估值误差的累积

## 注意事项

1. **网络连接**：需要稳定的网络连接来获取历史价格
2. **API限制**：CoinGecko API有请求频率限制，系统会自动控制请求速度
3. **时间匹配**：系统自动匹配CSV文件中的交易日期
4. **文件备份**：建议备份`historical_prices.json`文件
5. **价格更新**：每次运行都会重新获取最新的历史价格数据

## 示例场景

假设你在2024年1月15日用BTC购买了ETH：
- 如果没有历史价格：系统使用BTC平均取得单价计算，可能产生误差
- 如果有历史价格：系统使用2024-01-15的BTC价格计算，结果更准确

## 技术实现

- 使用CoinGecko免费API自动获取历史价格
- 多线程处理，避免界面卡顿
- 价格数据自动存储在JSON文件中
- 自动日期匹配，支持不同格式的日期
- 向后兼容，没有历史价格时仍可使用原方法
- 详细的日志输出，便于调试和验证

## 文件结构

```
crypto_calc/
├── crypto_calc.py          # 主程序
├── historical_prices.json  # 历史价格数据（自动生成）
├── example_prices.json     # 示例价格文件
└── README_历史价格功能.md   # 本说明文档
```

通过使用这个功能，你可以大大提高ETH/BTC交易损益计算的准确性！
